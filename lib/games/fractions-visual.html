<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fraction Factory ‚Äî Visual Learning</title>
<script src="/games/shared/utils.js"></script>
<style>
  html, body { margin:0; height:100%; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%); font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
  
  /* Start screen styles */
  #startScreen {
    position: fixed; inset: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    z-index: 1000; color: #ffffff;
  }
  #startScreen h1 { font-size: 48px; margin-bottom: 20px; text-shadow: 0 0 20px #ffffff; }
  #startScreen p { font-size: 20px; margin: 10px 0 30px 0; opacity: 0.9; }
  #startBtn {
    padding: 16px 32px; font-size: 24px; background: linear-gradient(135deg, #ff6b6b, #feca57);
    color: #ffffff; border: none; border-radius: 30px; cursor: pointer;
    font-weight: bold; transition: all 0.3s;
  }
  #startBtn:hover { transform: scale(1.1); box-shadow: 0 0 30px rgba(255, 107, 107, 0.8); }
  #loadingMessage { color: #ffffff; font-size: 20px; margin-top: 20px; }
  
  /* End screen styles */
  #endScreen {
    position: fixed; inset: 0; background: rgba(102, 126, 234, 0.95);
    display: none; flex-direction: column; justify-content: center; align-items: center;
    z-index: 1000; color: #ffffff;
  }
  #endScreen h2 { font-size: 42px; margin-bottom: 20px; text-shadow: 0 0 20px #ffffff; }
  #endScreen p { font-size: 20px; margin: 10px 0; opacity: 0.9; }
  #endStats { margin: 20px 0; font-size: 18px; }
  #endStats div { margin: 8px 0; }
  #continueBtn {
    padding: 16px 32px; font-size: 20px; background: linear-gradient(135deg, #ff6b6b, #feca57);
    color: #ffffff; border: none; border-radius: 99px; cursor: pointer;
    font-weight: bold; transition: all 0.3s; margin-top: 20px;
  }
  #continueBtn:hover { transform: scale(1.1); box-shadow: 0 0 30px rgba(255, 107, 107, 0.8); }
  #continueLoading { color: #ffffff; font-size: 18px; margin-top: 20px; }
  
  /* Game canvas and UI */
  #gameCanvas { position: fixed; inset: 0; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
  
  /* HUD styles */
  #ui { position:fixed; inset:0; pointer-events:none; }
  .hud {
    position: fixed; left:20px; top:20px; color:#333; font-size:18px; font-weight:bold;
    pointer-events:none;
  }
  .hud-item {
    margin-bottom: 8px;
    background: rgba(255, 255, 255, 0.9);
    padding: 8px 12px;
    border-radius: 8px;
    border: 2px solid #ff6b6b;
  }
  .hud-label {
    color: #ff6b6b;
    text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
  }
  .controls {
    position: fixed; bottom:20px; left:20px; color:#333;
    background: rgba(255, 255, 255, 0.9); padding:10px; border-radius:8px;
    border:2px solid #ff6b6b; font-size:14px;
  }
  .toast {
    position: fixed; right:20px; top:20px; padding:10px 16px; font-size:16px;
    color:#ffffff; background:rgba(255, 107, 107, 0.95); border:2px solid #feca57;
    border-radius:10px; pointer-events:none; display:none;
    text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }
  
  /* Question modal */
  .prompt { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.5); pointer-events:auto; }
  .card {
    width:min(720px,94vw); background:#ffffff; color:#333; border:3px solid #ff6b6b; border-radius:12px;
    box-shadow:0 10px 40px rgba(0,0,0,0.3); padding:20px;
  }
  .cardHeader { font-weight:700; font-size:16px; padding:6px 10px; border-radius:8px; margin-bottom:10px; background:#ff6b6b; color:#ffffff; }
  .q { font-size:26px; margin:10px 0 20px 0; text-align:center; }
  .choices { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top: 20px; }
  .btn {
    font-size:18px; padding:15px; border-radius:10px; border:2px solid #ff6b6b; background:#ffffff; color:#333;
    cursor:pointer; text-align:center; user-select:none; transition: all 0.2s;
  }
  .btn:hover { background:#ff6b6b; color:#ffffff; }
  .footer { font-size:12px; opacity:.9; margin-top:8px; text-align:center; }

  /* Fraction visualization */
  .vizWrap { display:flex; justify-content:center; margin:8px 0 4px 0; }
  canvas.viz { background:#ffffff; border:2px solid #ff6b6b; border-radius:8px; }
</style>
</head>
<body>
<!-- Start Screen -->
<div id="startScreen">
  <h1 id="gameTitle">üßÆ Fraction Factory</h1>
  <p id="gameDescription">Learn fractions with colorful visual tools!</p>
  <button id="startBtn">Start Learning</button>
  <div id="loadingMessage" style="display: none;">Loading fraction challenges...</div>
</div>

<!-- End Screen -->
<div id="endScreen">
  <h2 id="endTitle">Fraction Master!</h2>
  <p id="endSubtitle">Great job learning fractions!</p>
  <div id="endStats"></div>
  <button id="continueBtn">Keep Learning</button>
  <div id="continueLoading" style="display: none;">Loading more challenges...</div>
</div>

<!-- Game Canvas -->
<canvas id="gameCanvas" style="display: none;"></canvas>

<div id="ui">
  <div class="hud" id="hud">
    <div class="hud-item"><span class="hud-label">üéØ Score:</span> <span id="scoreValue">0</span></div>
    <div class="hud-item"><span class="hud-label">‚ù§Ô∏è Lives:</span> <span id="livesValue">3</span></div>
    <div class="hud-item"><span class="hud-label">üßÆ Completed:</span> <span id="completedValue">0</span></div>
    <div class="hud-item"><span class="hud-label">‚ö° Difficulty:</span> <span id="diffValue">EASY</span></div>
  </div>
  <div class="controls">
    <div>üéÆ Controls:</div>
    <div>1-4 - Answer Questions</div>
    <div>Click - Select Answers</div>
  </div>
  <div class="toast" id="toast"></div>
  
  <div class="prompt" id="prompt">
    <div class="card" id="card">
      <div class="cardHeader" id="cardHeader">Fraction Challenge</div>
      <div class="q" id="questionText">What fraction is shown?</div>
      
      <!-- Fraction visualization area -->
      <div class="vizWrap" id="vizWrap">
        <canvas class="viz" id="viz" width="400" height="200"></canvas>
      </div>
      
      <div class="choices">
        <div class="btn" data-choice="0" id="c0">1/2</div>
        <div class="btn" data-choice="1" id="c1">1/3</div>
        <div class="btn" data-choice="2" id="c2">2/3</div>
        <div class="btn" data-choice="3" id="c3">3/4</div>
      </div>
      <div class="footer" id="cardFooter">Answer with mouse or keys 1‚Äì4. Visual fractions help you learn!</div>
    </div>
  </div>
</div>

<script>
/* ==========================================================
   Fraction Factory ‚Äî Visual Fraction Learning Game
   - Interactive fraction bars and pie charts
   - Progressive difficulty with adaptive learning
   - Multiple choice questions about fraction concepts
   - Kid-friendly colorful design for ages 6+
   ========================================================== */

(() => {
  // Game props injected by server
  const props = {{GAME_PROPS}};
  
  const formatSpec = `Return questions in this exact JSON format:
{
  "question": "What fraction is represented by the shaded area?",
  "answers": ["1/2", "1/3", "2/3", "3/4"],
  "correctAnswerIndex": 0,
  "difficulty": "easy",
  "fractionData": {
    "numerator": 1,
    "denominator": 2,
    "visualType": "bar"
  }
}
Answers must be strings. difficulty must be one of: very-easy, easy, medium, hard, very-hard. Include fractionData for visualization with numerator, denominator, and visualType (bar or pie).`;

  // Question management
  let questions = [];
  let currentQuestionIndex = 0;
  let questionsLoading = false;
  let nextQuestionsLoading = false;
  let nextQuestions = [];
  let gameStarted = false;
  let questionsReady = false;
  
  // Game state
  let score = 0;
  let lives = 3;
  let completed = 0;
  let currentQuestion = null;
  let asking = false;
  let answerStartTime = 0;
  
  // UI elements
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const viz = document.getElementById('viz');
  const vctx = viz.getContext('2d');
  const startScreen = document.getElementById('startScreen');
  const endScreen = document.getElementById('endScreen');
  const startBtn = document.getElementById('startBtn');
  const continueBtn = document.getElementById('continueBtn');
  const promptEl = document.getElementById('prompt');
  const card = document.getElementById('card');
  const cardHeader = document.getElementById('cardHeader');
  const cardFooter = document.getElementById('cardFooter');
  const questionText = document.getElementById('questionText');
  const vizWrap = document.getElementById('vizWrap');
  const choiceEls = [document.getElementById('c0'), document.getElementById('c1'), document.getElementById('c2'), document.getElementById('c3')];
  const toast = document.getElementById('toast');
  const scoreEl = document.getElementById('scoreValue');
  const livesEl = document.getElementById('livesValue');
  const completedEl = document.getElementById('completedValue');
  const diffEl = document.getElementById('diffValue');
  
  // Initialize game
  GameUtils.initializeStats(props.gameId);
  GameUtils.setupCloseDetection();
  
  // Get next question from the queue
  function getNextQuestion() {
    if (currentQuestionIndex < questions.length) {
      return questions[currentQuestionIndex];
    }
    return null;
  }
  
  // Load initial questions
  async function loadInitialQuestions() {
    questionsLoading = true;
    document.getElementById('loadingMessage').style.display = 'block';
    
    try {
      questions = await GameUtils.generateQuestions(props, 10, formatSpec);
      questionsReady = questions.length > 0;
      
      if (questionsReady) {
        document.getElementById('loadingMessage').style.display = 'none';
        startGame();
      } else {
        document.getElementById('loadingMessage').textContent = 'Failed to load questions. Please try again.';
      }
    } catch (error) {
      console.error('Failed to load questions:', error);
      document.getElementById('loadingMessage').textContent = 'Failed to load questions. Please try again.';
    }
    
    questionsLoading = false;
  }
  
  // Load more questions in background
  async function loadMoreQuestions() {
    if (nextQuestionsLoading) return;
    
    nextQuestionsLoading = true;
    document.getElementById('continueLoading').style.display = 'block';
    
    try {
      nextQuestions = await GameUtils.generateQuestions(props, 10, formatSpec);
      
      if (nextQuestions.length > 0) {
        questions = questions.concat(nextQuestions);
        document.getElementById('continueLoading').style.display = 'none';
        showNextQuestion();
      } else {
        endGame('No More Questions', `You completed ${completed} fraction challenges! Score: ${score}`);
      }
    } catch (error) {
      console.error('Failed to load more questions:', error);
      endGame('Connection Error', `You completed ${completed} fraction challenges! Score: ${score}`);
    }
    
    nextQuestionsLoading = false;
  }
  
  // Start game
  function startGame() {
    startScreen.style.display = 'none';
    canvas.style.display = 'block';
    gameStarted = true;
    resizeCanvas();
    drawBackground();
    showNextQuestion();
  }
  
  // Show next question
  function showNextQuestion() {
    const Q = getNextQuestion();
    if (!Q) {
      loadMoreQuestions();
      return;
    }
    
    currentQuestion = Q;
    questionText.textContent = Q.question;
    
    // Ensure we have exactly 4 answers
    const answers = Q.answers.slice(0, 4);
    while (answers.length < 4) {
      answers.push("?");
    }
    
    // Update answer choices and reset colors
    choiceEls.forEach((el, i) => {
      el.textContent = answers[i] || "";
      el.style.background = "#ffffff";
      el.style.color = "#333";
      el.style.borderColor = "#ff6b6b";
    });
    
    // Draw fraction visualization
    const fractionData = Q.fractionData || {numerator: 1, denominator: 2, visualType: "bar"};
    drawFractionVisualization(fractionData);
    
    // Show visualization
    vizWrap.style.display = 'flex';
    cardFooter.textContent = 'Use keys 1‚Äì4 or click. Visual fractions help you learn!';
    
    promptEl.style.display = 'flex';
    asking = true;
    answerStartTime = performance.now() / 1000;
  }
  
  // Fraction visualization
  function drawFractionVisualization(fractionData) {
    const { numerator, denominator, visualType } = fractionData;
    vctx.clearRect(0, 0, viz.width, viz.height);
    
    if (visualType === "pie") {
      drawPieChart(numerator, denominator);
    } else {
      drawFractionBar(numerator, denominator);
    }
  }
  
  function drawFractionBar(numerator, denominator) {
    const barWidth = 300;
    const barHeight = 60;
    const startX = (viz.width - barWidth) / 2;
    const startY = (viz.height - barHeight) / 2;
    const segmentWidth = barWidth / denominator;
    
    // Draw segments
    for (let i = 0; i < denominator; i++) {
      const x = startX + i * segmentWidth;
      
      // Fill shaded segments
      if (i < numerator) {
        vctx.fillStyle = '#ff6b6b';
        vctx.fillRect(x, startY, segmentWidth, barHeight);
      } else {
        vctx.fillStyle = '#ffffff';
        vctx.fillRect(x, startY, segmentWidth, barHeight);
      }
      
      // Draw segment borders
      vctx.strokeStyle = '#333';
      vctx.lineWidth = 2;
      vctx.strokeRect(x, startY, segmentWidth, barHeight);
    }
    
    // Add fraction label
    vctx.fillStyle = '#333';
    vctx.font = '20px system-ui, sans-serif';
    vctx.textAlign = 'center';
    vctx.fillText(`${numerator}/${denominator}`, viz.width / 2, startY + barHeight + 30);
  }
  
  function drawPieChart(numerator, denominator) {
    const centerX = viz.width / 2;
    const centerY = viz.height / 2;
    const radius = 80;
    const anglePerSegment = (2 * Math.PI) / denominator;
    
    // Draw pie segments
    for (let i = 0; i < denominator; i++) {
      const startAngle = i * anglePerSegment - Math.PI / 2;
      const endAngle = (i + 1) * anglePerSegment - Math.PI / 2;
      
      vctx.beginPath();
      vctx.moveTo(centerX, centerY);
      vctx.arc(centerX, centerY, radius, startAngle, endAngle);
      vctx.closePath();
      
      // Fill shaded segments
      if (i < numerator) {
        vctx.fillStyle = '#ff6b6b';
      } else {
        vctx.fillStyle = '#ffffff';
      }
      vctx.fill();
      
      vctx.strokeStyle = '#333';
      vctx.lineWidth = 2;
      vctx.stroke();
    }
    
    // Add fraction label
    vctx.fillStyle = '#333';
    vctx.font = '20px system-ui, sans-serif';
    vctx.textAlign = 'center';
    vctx.fillText(`${numerator}/${denominator}`, centerX, centerY + radius + 30);
  }
  
  // Answer handling
  function handleChoice(idx) {
    if (!asking || !currentQuestion) return;
    const correct = (idx === currentQuestion.correctAnswerIndex);
    
    // Track the answer and question history
    const userAnswer = currentQuestion.answers[idx];
    GameUtils.trackAnswer(currentQuestion, userAnswer, correct);
    GameUtils.sendStats();
    
    // Visual feedback on the chosen button
    const chosenBtn = choiceEls[idx];
    const correctBtn = choiceEls[currentQuestion.correctAnswerIndex];
    
    if (correct) {
      // Flash correct button green
      chosenBtn.style.background = '#4ade80';
      chosenBtn.style.borderColor = '#22c55e';
      chosenBtn.style.color = '#ffffff';
      
      score += 10;
      completed++;
      updateHUD();
      showToast(`Correct! +10 points. Great job!`);
      
      // Send game stats
      GameUtils.sendGameStats(false);
      
      setTimeout(() => {
        hidePrompt();
        currentQuestionIndex++;
        setTimeout(showNextQuestion, 500);
      }, 1000);
    } else {
      // Flash chosen button red, show correct answer in green
      chosenBtn.style.background = '#ef4444';
      chosenBtn.style.borderColor = '#dc2626';
      chosenBtn.style.color = '#ffffff';
      correctBtn.style.background = '#4ade80';
      correctBtn.style.borderColor = '#22c55e';
      correctBtn.style.color = '#ffffff';
      
      lives = Math.max(0, lives - 1);
      updateHUD();
      showToast(`Wrong! Correct answer: ${correctBtn.textContent}. Life -1.`);
      
      // Send game stats
      GameUtils.sendGameStats(false);
      
      if (lives <= 0) {
        setTimeout(() => {
          hidePrompt();
          endGame('Game Over', `You completed ${completed} fraction challenges! Final Score: ${score}`);
        }, 1500);
      } else {
        setTimeout(() => {
          hidePrompt();
          currentQuestionIndex++;
          setTimeout(showNextQuestion, 500);
        }, 1500);
      }
    }
  }
  
  function hidePrompt() {
    asking = false;
    promptEl.style.display = 'none';
  }
  
  function updateHUD() {
    scoreEl.textContent = score;
    livesEl.textContent = lives;
    completedEl.textContent = completed;
    
    // Update difficulty based on performance
    const accuracy = completed > 0 ? (score / (completed * 10)) : 1;
    if (accuracy >= 0.9) diffEl.textContent = 'HARD';
    else if (accuracy >= 0.7) diffEl.textContent = 'MEDIUM';
    else diffEl.textContent = 'EASY';
  }
  
  function showToast(msg) {
    toast.textContent = msg;
    toast.style.display = 'block';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toast.style.display = 'none', 2000);
  }
  
  function endGame(title, subtitle) {
    GameUtils.sendGameStats(true);
    
    document.getElementById('endTitle').textContent = title;
    document.getElementById('endSubtitle').textContent = subtitle;
    
    const stats = GameUtils.getCurrentStats();
    const statsEl = document.getElementById('endStats');
    if (typeof stats === 'object') {
      statsEl.innerHTML = `
        <div>‚è±Ô∏è Time: ${stats.playTime}</div>
        <div>‚ùì Questions: ${stats.questions}</div>
        <div>‚úÖ Correct: ${stats.correct}</div>
        <div>üìä Grade: ${stats.grade}</div>
      `;
    } else {
      statsEl.innerHTML = `<div>${stats}</div>`;
    }
    
    canvas.style.display = 'none';
    endScreen.style.display = 'flex';
  }
  
  function drawBackground() {
    ctx.fillStyle = '#ff9a9e';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Draw some decorative elements
    ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
    for (let i = 0; i < 20; i++) {
      const x = Math.random() * canvas.width;
      const y = Math.random() * canvas.height;
      const size = Math.random() * 30 + 10;
      ctx.beginPath();
      ctx.arc(x, y, size, 0, Math.PI * 2);
      ctx.fill();
    }
  }
  
  // Resize canvas
  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    if (gameStarted) {
      drawBackground();
    }
  }
  
  // Event listeners
  startBtn.addEventListener('click', loadInitialQuestions);
  continueBtn.addEventListener('click', loadMoreQuestions);
  
  // Keyboard input
  window.addEventListener('keydown', (e) => {
    if (asking && ['1', '2', '3', '4'].includes(e.key)) {
      handleChoice(parseInt(e.key, 10) - 1);
      return;
    }
  });
  
  // Mouse input
  choiceEls.forEach((el, idx) => el.addEventListener('click', () => handleChoice(idx)));
  
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();
})();
</script>
</body>
</html>
