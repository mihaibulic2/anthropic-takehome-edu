<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blind Spot</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      height: 100vh;
      background: #f0f0f0;
    }

    #container {
      display: flex;
      height: 100vh;
    }

    /* Slack-like Layout */
    #employee-sidebar {
      width: 250px;
      background: #3f0f40;
      color: white;
      display: flex;
      flex-direction: column;
    }

    #sidebar-header {
      padding: 15px 20px;
      background: #350d36;
      border-bottom: 1px solid #522653;
      font-weight: bold;
    }

    #employee-list-sidebar {
      flex: 1;
      overflow-y: auto;
    }

    .sidebar-employee {
      display: flex;
      align-items: center;
      padding: 8px 20px;
      cursor: pointer;
      transition: background 0.2s;
      border-left: 3px solid transparent;
    }

    .sidebar-employee:hover {
      background: rgba(255,255,255,0.1);
    }

    .sidebar-employee.active {
      background: #1264a3;
      border-left-color: #ffffff;
    }

    .sidebar-employee-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .sidebar-employee-name {
      flex: 1;
      font-size: 14px;
    }

    #main-chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
    }

    #chat-header {
      padding: 15px 20px;
      background: white;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #chat-header-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }

    #chat-header-info {
      flex: 1;
    }

    #chat-header-name {
      font-weight: bold;
      font-size: 16px;
    }

    #chat-header-status {
      font-size: 12px;
      color: #666;
    }

    #chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: white;
    }

    #chat-input-area {
      padding: 20px;
      border-top: 1px solid #ddd;
      background: white;
    }

    #chat-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      resize: none;
      outline: none;
    }

    #chat-input:focus {
      border-color: #1264a3;
      box-shadow: 0 0 0 1px #1264a3;
    }

    .chat-message {
      margin-bottom: 16px;
    }

    .chat-message-header {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .chat-message-name {
      font-weight: bold;
      color: #1264a3;
      font-size: 14px;
    }

    .chat-message-time {
      font-size: 11px;
      color: #888;
    }

    .chat-message-text {
      font-size: 14px;
      line-height: 1.5;
    }

    .chat-message.user .chat-message-name {
      color: #0f7b0f;
    }

    #scene-container {
      display: none; /* Hide the 2D office scene */
    }

    /* 2D Office Scene */
    #office-scene {
      width: 100%;
      height: 100%;
      position: relative;
      background: #4a7c59;
      background-image: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
      background-size: 20px 20px;
    }

    .desk {
      position: absolute;
      width: 80px;
      height: 60px;
      background: #8B4513;
      border: 2px solid #654321;
      border-radius: 4px;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .computer {
      position: absolute;
      width: 25px;
      height: 20px;
      background: #333;
      border: 1px solid #666;
      border-radius: 2px;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
    }

    .computer::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 15px;
      background: #87CEEB;
      border: 1px solid #4682B4;
      top: 1px;
      left: 1px;
      border-radius: 1px;
    }

    .employee {
      position: absolute;
      width: 32px;
      height: 32px;
      cursor: pointer;
      transition: transform 0.2s;
      z-index: 10;
    }

    .employee:hover {
      transform: scale(1.1);
      filter: brightness(1.2);
    }

    .employee-sprite {
      width: 32px;
      height: 32px;
      background: #FFE4B5;
      border: 2px solid #DEB887;
      border-radius: 50% 50% 60% 60%;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .employee-hair {
      position: absolute;
      width: 28px;
      height: 20px;
      border-radius: 50% 50% 30% 30%;
      top: -2px;
      left: 2px;
    }

    .employee-shirt {
      position: absolute;
      width: 24px;
      height: 16px;
      border-radius: 0 0 50% 50%;
      bottom: -8px;
      left: 4px;
    }

    .employee-name {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      white-space: nowrap;
      pointer-events: none;
    }

    #right-pane {
      width: 400px;
      background: white;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }

    #situation {
      padding: 15px;
      background: #f8f8f8;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      line-height: 1.5;
    }

    #event-log {
      flex: 1;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: white;
      margin-bottom: 20px;
    }

    .event-item {
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      font-size: 13px;
      line-height: 1.4;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .event-item:last-child {
      border-bottom: none;
    }

    .event-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 1px;
    }

    .event-content {
      flex: 1;
    }

    .event-names {
      font-weight: bold;
      font-size: 11px;
      color: #666;
      margin-bottom: 2px;
    }

    .event-text {
      color: #333;
    }

    .event-item.highlighted {
      background-color: rgba(100, 100, 100, 0.1);
      border-radius: 4px;
      padding: 12px 8px;
      margin: 0 -8px;
    }

    #phase-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    button:hover {
      background: #0056b3;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #conversation-panel {
      display: none; /* Hidden since we're using the new Slack interface */
    }

    #conversation-header {
      padding: 20px;
      background: #007bff;
      color: white;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #conversation-history {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      max-height: 400px;
    }

    .message {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
    }

    .message.player {
      background: #007bff;
      color: white;
      margin-left: 40px;
      text-align: right;
    }

    .message.npc {
      background: #f0f0f0;
      margin-right: 40px;
    }

    .message-speaker {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 12px;
      opacity: 0.8;
    }

    #conversation-input-area {
      padding: 20px;
      border-top: 1px solid #ddd;
    }

    #conversation-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      resize: none;
    }

    #send-message {
      margin-top: 10px;
      width: 100%;
    }

    .close-btn {
      background: transparent;
      color: white;
      font-size: 24px;
      padding: 0;
      width: 30px;
      height: 30px;
      cursor: pointer;
    }

    #reveal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      z-index: 2000;
    }

    #reveal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 1200px;
      height: 80%;
      background: white;
      border-radius: 12px;
      padding: 30px;
      display: flex;
      flex-direction: column;
    }

    #reveal-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #ddd;
    }

    #reveal-boxes {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: calc(100% - 80px); /* Fixed height for entire container */
    }

    .reveal-row {
      display: flex;
      gap: 2%;
      height: 200px; /* Fixed height for each row */
      margin-bottom: 20px;
    }

    .reveal-row:last-child {
      margin-bottom: 0;
    }

    .reveal-box {
      width: 30%;
      height: 200px; /* Fixed height for ALL boxes */
      border-radius: 8px;
      padding: 15px;
      overflow-y: auto;
      position: relative;
      flex-shrink: 0;
    }

    .reveal-row:first-child .reveal-box:last-child {
      width: 36%;
      height: 200px; /* Fixed height even for wider feedback box */
    }

    .reveal-box h3 {
      margin-bottom: 10px;
      font-size: 16px;
      font-weight: 600;
    }

    .reveal-box.events {
      border: 2px solid #28a745;
    }

    .reveal-box.public-info {
      border: 2px solid #007bff;
    }

    .reveal-box.feedback {
      border: 2px solid #ffc107;
    }

    .reveal-box.secret-info {
      border: 2px solid #dc3545;
      cursor: pointer;
      transition: all 0.3s;
    }

    .reveal-box.employee-reaction {
      border: 2px solid #6f42c1;
      cursor: pointer;
      transition: all 0.3s;
    }

    .reveal-box.hidden {
      background: #dc3545;
      color: #dc3545;
    }

    .reveal-box.hidden.employee-reaction {
      background: #6f42c1;
      color: #6f42c1;
    }

    .reveal-box.hidden::before {
      content: "🔒 Click to reveal";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      font-size: 14px;
      text-align: center;
    }

    .reveal-box.revealed {
      background: white;
      color: black;
    }

    #reveal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #dc3545;
    }

    /* Instruction Overlay */
    #instruction-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.8);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .instruction-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }

    .instruction-content h2 {
      color: #2d5a27;
      margin-bottom: 20px;
    }

    .instruction-content p {
      margin-bottom: 15px;
      line-height: 1.6;
    }

    .instruction-btn {
      background: #2d5a27;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 15px;
    }

    .instruction-btn:hover {
      background: #4a7c59;
    }

    #employee-selection {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      z-index: 1500;
    }

    #employee-list {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
    }

    #employee-list h2 {
      margin-bottom: 20px;
      text-align: center;
    }

    .employee-item {
      padding: 15px;
      margin-bottom: 10px;
      background: #f8f8f8;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
    }

    .employee-item:hover {
      background: #e8e8e8;
    }

    .employee-item.completed {
      background: #e8f5e8;
      border-left: 4px solid #28a745;
    }

    .employee-item.completed::after {
      content: "✓";
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #28a745;
      font-weight: bold;
      font-size: 18px;
    }

    #restart-btn {
      margin-top: 20px;
      width: 100%;
      background: #dc3545;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .narrative-cue {
      font-style: italic;
      opacity: 0.8;
      margin-top: 5px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="utils.js"></script>
</head>
<body>
  <div id="container">
    <!-- Employee Sidebar (like Slack channels) -->
    <div id="employee-sidebar">
      <div id="sidebar-header">Team Chat</div>
      <div id="employee-list-sidebar">
        <!-- Employee list will be populated here -->
      </div>
    </div>
    
    <!-- Main Chat Area -->
    <div id="main-chat-area">
      <div id="chat-header">
        <div id="chat-header-avatar"></div>
        <div id="chat-header-info">
          <div id="chat-header-name">Select an employee</div>
          <div id="chat-header-status">Click on a team member to start chatting</div>
        </div>
      </div>
      <div id="chat-messages">
        <div id="welcome-message" style="text-align: center; color: #666; margin-top: 40px;">
          <p>Select a team member from the sidebar to start a conversation</p>
        </div>
      </div>
      <div id="chat-input-area" style="display: none;">
        <textarea id="chat-input" rows="3" placeholder="Type your message..."></textarea>
        <div style="margin-top: 8px;">
          <button id="send-chat-message" onclick="sendMessage()" style="background: #1264a3;">Send</button>
        </div>
      </div>
    </div>
    
    <!-- Right Panel for Situation & Events -->
    <div id="right-pane">
      <div id="situation"></div>
      <div id="event-log"></div>
      <div id="phase-controls">
        <button id="feedback-btn" onclick="goToFeedback()">Go to Feedback</button>
        <button id="reveal-btn" onclick="goToReveal()" style="display: none;">Reveal</button>
      </div>
    </div>
    
    <!-- Hidden original scene container -->
    <div id="scene-container" style="display: none;">
      <div id="office-scene">
        <div id="employees-container"></div>
      </div>
    </div>
  </div>

  <div id="conversation-panel">
    <div class="conversation-content">
      <div class="conversation-left">
        <div class="conversation-npc" id="conversation-npc-avatar">
          <!-- NPC avatar will be dynamically created here -->
        </div>
      </div>
      <div class="conversation-right">
        <div class="conversation-header">
          <h3 id="conversation-title"></h3>
          <button class="close-btn" onclick="closeConversation()">&times;</button>
        </div>
        <div class="conversation-messages" id="conversation-history"></div>
        <div class="conversation-input">
          <textarea id="conversation-input" rows="3" placeholder="Type your message..."></textarea>
          <button id="send-message" onclick="sendMessage()">Send</button>
        </div>
      </div>
    </div>
  </div>

  <div id="employee-selection">
    <div id="employee-list">
      <h2>Select Employee to Review</h2>
      <div id="employee-items"></div>
      <button id="restart-btn" onclick="restartGame()">Restart Game</button>
    </div>
  </div>

  <div id="reveal-overlay">
    <div id="reveal-content">
      <div id="reveal-header">
        <h2 id="reveal-employee-name"></h2>
      </div>
      <div id="reveal-boxes">
        <div class="reveal-row">
          <div class="reveal-box events">
            <h3>Events</h3>
            <div id="reveal-events-content"></div>
          </div>
          <div class="reveal-box public-info">
            <h3>Public Info</h3>
            <div id="reveal-public-content"></div>
          </div>
          <div class="reveal-box feedback">
            <h3>Your Feedback</h3>
            <div id="reveal-feedback-content"></div>
          </div>
        </div>
        <div class="reveal-row">
          <div class="reveal-box secret-info hidden" onclick="revealBox(this, 'secret')">
            <h3>Secret Info</h3>
            <div id="reveal-secret-content"></div>
          </div>
          <div class="reveal-box employee-reaction hidden" onclick="revealBox(this, 'reaction')">
            <h3>Employee Reaction</h3>
            <div id="reveal-reaction-content"></div>
          </div>
        </div>
      </div>
      <button id="reveal-close" onclick="closeRevealOverlay()">Close</button>
    </div>
  </div>

  <script>
    // Game State
    let gameState = {
      situation: "The marketing team has been struggling with deadlines for the past month. Several key deliverables have been delayed, causing friction with other departments. As the team manager, you need to understand what's happening and provide feedback to help the team improve.",
      npcs: [
        {
          id: "sarah_chen",
          name: "Sarah Chen",
          publicDescription: "Senior Marketing Specialist, 5 years with company, usually reliable",
          secretDescription: "Her 8-year-old daughter was diagnosed with leukemia 6 weeks ago. She hasn't told anyone at work because she fears it will affect her upcoming promotion.",
          color: "#3498db"
        },
        {
          id: "marcus_williams",
          name: "Marcus Williams",
          publicDescription: "Junior Marketing Associate, 8 months with company, enthusiastic but sometimes misses details",
          secretDescription: "Has undiagnosed ADHD and struggles with task prioritization. He's been trying various personal productivity systems but hasn't found one that works yet.",
          color: "#2ecc71"
        },
        {
          id: "jennifer_russo",
          name: "Jennifer Russo",
          publicDescription: "Marketing Coordinator, 2 years with company, handles logistics and scheduling",
          secretDescription: "Has been doing the work of two people since a colleague left 3 months ago. HR promised a replacement but keeps delaying. She's been applying to other jobs.",
          color: "#e74c3c"
        }
      ],
      events: [
        { text: "Sarah arrived 45 minutes late to Monday's strategy meeting", involvedNpcs: ["sarah_chen"] },
        { text: "Marcus submitted the campaign brief with several formatting errors", involvedNpcs: ["marcus_williams"] },
        { text: "Jennifer rescheduled the vendor meeting twice this week", involvedNpcs: ["jennifer_russo"] },
        { text: "Sarah and Marcus had a tense exchange about project timelines in the break room", involvedNpcs: ["sarah_chen", "marcus_williams"] },
        { text: "Jennifer sent an email at 11 PM about updating the project tracker", involvedNpcs: ["jennifer_russo"] }
      ],
      conversations: {},
      feedbackSummaries: {},
      feedbackReactions: {},
      completedEmployees: {},
      phase: "explore"
    };

    let currentNPC = null;
    let selectedEmployeeId = null;
    let hasGeneratedEventsThisConversation = false;
    let conversationsHadCount = 0;

    // Initialize Slack-like interface
    function initScene() {
      createEmployeeSidebar();
      updateEventHighlighting();
    }

    function createEmployeeSidebar() {
      const sidebar = document.getElementById('employee-list-sidebar');
      sidebar.innerHTML = '';
      
      gameState.npcs.forEach((npc, index) => {
        const employeeDiv = document.createElement('div');
        employeeDiv.className = 'sidebar-employee';
        employeeDiv.dataset.npcId = npc.id;
        
        // Avatar circle
        const avatar = document.createElement('div');
        avatar.className = 'sidebar-employee-avatar';
        avatar.style.backgroundColor = npc.color;
        
        // Name
        const name = document.createElement('div');
        name.className = 'sidebar-employee-name';
        name.textContent = npc.name;
        
        employeeDiv.appendChild(avatar);
        employeeDiv.appendChild(name);
        
        // Click handler
        employeeDiv.addEventListener('click', () => {
          selectEmployee(npc.id);
        });
        
        sidebar.appendChild(employeeDiv);
      });
      
      // Auto-select first employee
      if (gameState.npcs.length > 0) {
        selectEmployee(gameState.npcs[0].id);
      }
    }

    function selectEmployee(npcId) {
      selectedEmployeeId = npcId;
      currentNPC = gameState.npcs.find(n => n.id === npcId);
      
      // Update sidebar selection
      document.querySelectorAll('.sidebar-employee').forEach(emp => {
        emp.classList.remove('active');
      });
      document.querySelector(`[data-npc-id="${npcId}"]`).classList.add('active');
      
      // Update chat header
      const npc = currentNPC;
      document.getElementById('chat-header-name').textContent = npc.name;
      document.getElementById('chat-header-status').textContent = npc.publicDescription;
      
      const headerAvatar = document.getElementById('chat-header-avatar');
      headerAvatar.style.backgroundColor = npc.color;
      
      // Hide welcome message and show chat input area
      const welcomeMessage = document.getElementById('welcome-message');
      if (welcomeMessage) {
        welcomeMessage.style.display = 'none';
      }
      document.getElementById('chat-input-area').style.display = 'block';
      
      // Update conversation history
      updateChatMessages();
      
      // Highlight events for this employee
      updateEventHighlighting();
    }

    function updateEventHighlighting() {
      const eventItems = document.querySelectorAll('.event-item');
      eventItems.forEach((item, index) => {
        item.classList.remove('highlighted');
        if (selectedEmployeeId) {
          const event = gameState.events[index];
          if (event && event.involvedNpcs && event.involvedNpcs.includes(selectedEmployeeId)) {
            item.classList.add('highlighted');
          }
        }
      });
    }

    // Animation loop for 2D effects
    function animate() {
      requestAnimationFrame(animate);
      
      // Add subtle hover effects or animations here if needed
    }

    // UI Functions
    function updateUI() {
      // Update situation
      document.getElementById('situation').innerHTML = `<strong>Situation:</strong> ${gameState.situation}`;
      
      // Update event log
      const eventLog = document.getElementById('event-log');
      eventLog.innerHTML = '<h3>Event Log</h3>';
      gameState.events.forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'event-item';
        
        // Create avatar circle (using primary employee's color)
        const avatar = document.createElement('div');
        avatar.className = 'event-avatar';
        if (event.involvedNpcs && event.involvedNpcs.length > 0) {
          const primaryNpc = gameState.npcs.find(n => n.id === event.involvedNpcs[0]);
          avatar.style.backgroundColor = primaryNpc ? primaryNpc.color : '#ccc';
        } else {
          avatar.style.backgroundColor = '#ccc';
        }
        
        // Create content div
        const content = document.createElement('div');
        content.className = 'event-content';
        
        // Add names
        if (event.involvedNpcs && event.involvedNpcs.length > 0) {
          const names = document.createElement('div');
          names.className = 'event-names';
          const npcNames = event.involvedNpcs.map(id => {
            const npc = gameState.npcs.find(n => n.id === id);
            return npc ? npc.name : id;
          }).join(', ');
          names.textContent = npcNames;
          content.appendChild(names);
        }
        
        // Add event text
        const text = document.createElement('div');
        text.className = 'event-text';
        text.textContent = event.text;
        content.appendChild(text);
        
        eventDiv.appendChild(avatar);
        eventDiv.appendChild(content);
        eventLog.appendChild(eventDiv);
      });
      eventLog.scrollTop = eventLog.scrollHeight;

      // Update phase controls
      if (gameState.phase === "feedback") {
        document.getElementById('feedback-btn').style.display = 'none';
        document.getElementById('reveal-btn').style.display = 'block';
      } else if (gameState.phase === "reveal") {
        document.getElementById('feedback-btn').style.display = 'none';
        document.getElementById('reveal-btn').style.display = 'none';
      }
      
      // Update event highlighting after DOM is rebuilt
      setTimeout(() => updateEventHighlighting(), 0);
    }

    function updateChatMessages() {
      const chatMessages = document.getElementById('chat-messages');
      chatMessages.innerHTML = '';
      
      if (!currentNPC) return;
      
      const messages = gameState.conversations[currentNPC.id] || [];
      messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message';
        
        // Message header with name and time
        const header = document.createElement('div');
        header.className = 'chat-message-header';
        
        const nameSpan = document.createElement('span');
        nameSpan.className = `chat-message-name ${msg.speaker === 'player' ? 'user' : 'npc'}`;
        nameSpan.textContent = msg.speaker === 'player' ? 'You' : msg.speaker;
        
        const timeSpan = document.createElement('span');
        timeSpan.className = 'chat-message-time';
        timeSpan.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        header.appendChild(nameSpan);
        header.appendChild(timeSpan);
        
        // Message text
        const textDiv = document.createElement('div');
        textDiv.className = 'chat-message-text';
        
        // Parse narrative cues
        const text = msg.text;
        const parts = text.split(/(\\[.*?\\])/);
        parts.forEach(part => {
          if (part.startsWith('[') && part.endsWith(']')) {
            const cueSpan = document.createElement('em');
            cueSpan.textContent = part;
            cueSpan.style.opacity = '0.7';
            textDiv.appendChild(cueSpan);
          } else if (part) {
            textDiv.appendChild(document.createTextNode(part));
          }
        });
        
        messageDiv.appendChild(header);
        messageDiv.appendChild(textDiv);
        chatMessages.appendChild(messageDiv);
      });
      
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Conversation Management
    function openConversation(npcId) {
      currentNPC = gameState.npcs.find(n => n.id === npcId);
      if (!currentNPC) return;

      hasGeneratedEventsThisConversation = false; // Reset flag for new conversation
      
      document.getElementById('conversation-title').textContent = currentNPC.name;
      
      // Create NPC avatar for conversation
      const avatar = document.getElementById('conversation-npc-avatar');
      avatar.innerHTML = '';
      
      const sprite = document.createElement('div');
      sprite.className = 'employee-sprite';
      sprite.style.width = '120px';
      sprite.style.height = '120px';
      
      const hair = document.createElement('div');
      hair.className = 'employee-hair';
      hair.style.background = getHairColor(currentNPC.visual.hairColor);
      hair.style.width = '112px';
      hair.style.height = '80px';
      hair.style.top = '-8px';
      hair.style.left = '4px';
      sprite.appendChild(hair);
      
      const shirt = document.createElement('div');
      shirt.className = 'employee-shirt';
      shirt.style.background = getShirtColor(gameState.npcs.findIndex(n => n.id === npcId));
      shirt.style.width = '96px';
      shirt.style.height = '64px';
      shirt.style.bottom = '-32px';
      shirt.style.left = '12px';
      sprite.appendChild(shirt);
      
      avatar.appendChild(sprite);
      
      document.getElementById('conversation-panel').style.display = 'flex';
      
      updateConversationHistory();
    }

    function closeConversation() {
      document.getElementById('conversation-panel').style.display = 'none';
      
      conversationsHadCount++;
      
      // Generate events when leaving a conversation (but only once per conversation)
      if (gameState.phase === "explore" && !hasGeneratedEventsThisConversation) {
        hasGeneratedEventsThisConversation = true;
        generateEvents();
      }
      
      // Show instruction after first conversation
      if (conversationsHadCount === 1) {
        showInstructions(
          "New Events!", 
          "New events can come in between conversations. Keep talking to employees and press the feedback button when you're ready to evaluate everyone."
        );
      }
      
      currentNPC = null;
      document.getElementById('conversation-input').value = '';
    }

    function updateConversationHistory() {
      const history = document.getElementById('conversation-history');
      history.innerHTML = '';
      
      const messages = gameState.conversations[currentNPC.id] || [];
      messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.speaker === 'player' ? 'player' : 'npc'}`;
        
        const speakerDiv = document.createElement('div');
        speakerDiv.className = 'message-speaker';
        speakerDiv.textContent = msg.speaker === 'player' ? 'You' : msg.speaker;
        
        const textDiv = document.createElement('div');
        
        // Parse narrative cues
        const text = msg.text;
        const parts = text.split(/(\[.*?\])/);
        parts.forEach(part => {
          if (part.startsWith('[') && part.endsWith(']')) {
            const cueSpan = document.createElement('div');
            cueSpan.className = 'narrative-cue';
            cueSpan.textContent = part;
            textDiv.appendChild(cueSpan);
          } else if (part) {
            textDiv.appendChild(document.createTextNode(part));
          }
        });
        
        messageDiv.appendChild(speakerDiv);
        messageDiv.appendChild(textDiv);
        history.appendChild(messageDiv);
      });
      
      history.scrollTop = history.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message || !currentNPC) return;

      input.disabled = true;
      document.getElementById('send-chat-message').disabled = true;

      // Add player message
      if (!gameState.conversations[currentNPC.id]) {
        gameState.conversations[currentNPC.id] = [];
      }
      gameState.conversations[currentNPC.id].push({ speaker: 'player', text: message });
      updateChatMessages();
      
      // Clear input
      input.value = '';

      // Generate NPC response
      const response = await generateNPCResponse(currentNPC.id, message);
      if (response) {
        gameState.conversations[currentNPC.id].push({ 
          speaker: currentNPC.name, 
          text: response 
        });
        updateChatMessages();
      }

      input.disabled = false;
      document.getElementById('send-chat-message').disabled = false;
      input.focus();
    }

    // Instruction system
    function showInstructions(title, text) {
      document.getElementById('instruction-title').textContent = title;
      document.getElementById('instruction-text').innerHTML = `<p>${text}</p>`;
      document.getElementById('instruction-overlay').style.display = 'flex';
    }

    function closeInstructions() {
      document.getElementById('instruction-overlay').style.display = 'none';
    }

    // Phase Management
    function goToFeedback() {
      gameState.phase = "feedback";
      updateUI();
      
      // Show feedback instructions
      showInstructions(
        "Feedback Phase", 
        "Now talk to each person you want to give feedback to. Click on employees to have feedback conversations. Press 'Reveal' when you're done giving feedback."
      );
    }

    function goToReveal() {
      const talkedToNPCs = Object.keys(gameState.conversations);
      const feedbackGiven = talkedToNPCs.filter(npcId => {
        const conv = gameState.conversations[npcId] || [];
        return conv.some(msg => msg.speaker === 'player') && gameState.phase === 'feedback';
      });

      if (feedbackGiven.length < gameState.npcs.length) {
        const missing = gameState.npcs.length - feedbackGiven.length;
        if (!confirm(`You haven't given feedback to ${missing} employee(s). Do you want to proceed to reveal anyway?`)) {
          return;
        }
      }

      gameState.phase = "reveal";
      updateUI();
      showEmployeeSelection();
      
      // Show reveal instructions
      showInstructions(
        "Reveal Phase", 
        "Select each person to see their information and feedback results. Click on the colored boxes to reveal hidden information about each employee."
      );
    }

    function showEmployeeSelection() {
      const employeeItems = document.getElementById('employee-items');
      employeeItems.innerHTML = '';
      
      gameState.npcs.forEach(npc => {
        const item = document.createElement('div');
        item.className = 'employee-item';
        if (gameState.completedEmployees[npc.id]) {
          item.classList.add('completed');
        }
        item.innerHTML = `<strong>${npc.name}</strong><br>${npc.publicDescription}`;
        item.onclick = () => showRevealOverlay(npc.id);
        employeeItems.appendChild(item);
      });
      
      document.getElementById('employee-selection').style.display = 'block';
    }

    async function showRevealOverlay(npcId) {
      const npc = gameState.npcs.find(n => n.id === npcId);
      if (!npc) return;

      // HIDE the overlay first while we set everything up
      document.getElementById('employee-selection').style.display = 'none';
      document.getElementById('reveal-overlay').style.display = 'none';

      // SET THE EMPLOYEE NAME
      document.getElementById('reveal-employee-name').textContent = npc.name;

      // SET ALL CONTENT IMMEDIATELY - EVERYTHING WE HAVE
      // 1. Events - always available immediately
      const npcEvents = gameState.events.filter(e => e.involvedNpcs.includes(npcId));
      document.getElementById('reveal-events-content').innerHTML = npcEvents.map(e => `<div class="event-item">${e.text}</div>`).join('');

      // 2. Public Info - always available immediately
      document.getElementById('reveal-public-content').innerHTML = npc.publicDescription;

      // 3. Secret Info - ALWAYS available immediately
      document.getElementById('reveal-secret-content').innerHTML = npc.secretDescription;

      // 4. Feedback Summary - set what we have or "Generating"
      const feedbackContent = document.getElementById('reveal-feedback-content');
      if (gameState.feedbackSummaries[npcId]) {
        feedbackContent.innerHTML = gameState.feedbackSummaries[npcId];
      } else {
        feedbackContent.innerHTML = '<div class="loading">Generating summary...</div>';
      }

      // 5. Employee Reaction - set what we have or "Generating"  
      const reactionContent = document.getElementById('reveal-reaction-content');
      if (gameState.feedbackReactions[npcId]) {
        reactionContent.innerHTML = gameState.feedbackReactions[npcId];
      } else {
        reactionContent.innerHTML = '<div class="loading">Generating reaction...</div>';
      }

      // ENSURE SECRET AND REACTION BOXES ARE HIDDEN
      const secretBox = document.querySelector('.secret-info');
      const reactionBox = document.querySelector('.employee-reaction');
      secretBox.classList.add('hidden');
      secretBox.classList.remove('revealed');
      reactionBox.classList.add('hidden');
      reactionBox.classList.remove('revealed');

      // NOW SHOW THE OVERLAY - EVERYTHING IS SET!
      document.getElementById('reveal-overlay').style.display = 'block';

      // FIRE OFF LLM REQUESTS FOR MISSING CONTENT (async, don't wait)
      if (!gameState.feedbackSummaries[npcId]) {
        generateFeedbackSummary(npcId).then(summary => {
          gameState.feedbackSummaries[npcId] = summary || 'No feedback provided';
          document.getElementById('reveal-feedback-content').innerHTML = gameState.feedbackSummaries[npcId];
        });
      }

      if (!gameState.feedbackReactions[npcId]) {
        generateFeedbackReaction(npcId).then(reaction => {
          gameState.feedbackReactions[npcId] = reaction || 'Unable to generate reaction';
          document.getElementById('reveal-reaction-content').innerHTML = gameState.feedbackReactions[npcId];
        });
      }
    }

    function revealBox(element, type) {
      if (element.classList.contains('hidden')) {
        element.classList.remove('hidden');
        element.classList.add('revealed');
        
        // Get current employee info
        const currentEmployeeName = document.getElementById('reveal-employee-name').textContent;
        const currentEmployee = gameState.npcs.find(npc => npc.name === currentEmployeeName);
        
        // Check if both secret boxes are now revealed
        const secretBox = document.querySelector('.secret-info');
        const reactionBox = document.querySelector('.employee-reaction');
        
        if (currentEmployee && 
            secretBox.classList.contains('revealed') && 
            reactionBox.classList.contains('revealed')) {
          // Mark this employee as completed
          gameState.completedEmployees[currentEmployee.id] = true;
        }
      }
    }

    function closeRevealOverlay() {
      document.getElementById('reveal-overlay').style.display = 'none';
      showEmployeeSelection(); // Refresh the list to show updated checkmarks
    }

    function restartGame() {
      location.reload();
    }

    // LLM Helper Functions
    async function generateNPCResponse(npcId, playerMessage) {
      const npc = gameState.npcs.find(n => n.id === npcId);
      if (!npc) return null;

      const talkedToNPCs = Object.keys(gameState.conversations);
      
      const prompt = `You are ${npc.name}, ${npc.publicDescription}. You are in the middle of a workplace situation: ${gameState.situation}.

CONTEXT:
- Your hidden context: ${npc.secretDescription}
- Current phase: ${gameState.phase} (explore = building understanding, feedback = providing performance reviews)
- Events so far: ${JSON.stringify(gameState.events)}
- Previous conversations with you: ${JSON.stringify(gameState.conversations[npcId] || [])}
- Player role: You are being managed/evaluated by this player who is your supervisor

Player says: "${playerMessage}"

Respond as ${npc.name} in character. Your behavior should reflect the current phase:
- In explore: Be natural, discuss work situations, share your perspective on events
- In feedback: Be more receptive to evaluation, ask clarifying questions, show emotional responses to criticism/praise

Your responses should be authentic to your hidden context without explicitly revealing the secret information. Let your hidden situation influence your stress levels, reactions, and behaviors naturally. This conversation is happening over Slack (this is the only way to communicate in this situation, do not ask to meet in person)

Keep your response concise (3 sentences max, but can be shorter).`;

      const response = await GameUtils.getLLMResponse(prompt);
      return response || "...";
    }

    async function generateEvents() {
      const prompt = `Based on the current workplace situation and recent developments, optionally generate new realistic events. Consider what would naturally happen next given the conversations and existing events.

FULL CONTEXT:
- Situation: ${gameState.situation}
- NPCs: ${JSON.stringify(gameState.npcs)}
- Existing events: ${JSON.stringify(gameState.events)}
- Recent conversations: ${JSON.stringify(gameState.conversations)}
- Current phase: ${gameState.phase}

Generate 0-3 new events that would realistically occur based on this context. Events should feel natural and consequences of previous interactions.
Return empty array [] if no new events are warranted.
Output as a JSON array of event objects with format: { "text": "event description", "involvedNpcs": ["npc_id1", "npc_id2"] }

IMPORTANT: You have access to secret descriptions to create realistic cause-and-effect events, but must NEVER explicitly reveal the secret information in the event text. Events show observable behaviors/outcomes only (e.g., 'Sarah arrived late' not 'Sarah arrived late because her kid is sick').

Return ONLY the JSON array, no other text.`;

      try {
        const response = await GameUtils.getLLMResponse(prompt);
        if (response) {
          const newEvents = JSON.parse(response);
          if (Array.isArray(newEvents) && newEvents.length > 0) {
            gameState.events.push(...newEvents);
            updateUI();
          }
        }
      } catch (error) {
        console.error('Failed to generate events:', error);
      }
    }

    async function generateFeedbackSummary(npcId) {
      const npc = gameState.npcs.find(n => n.id === npcId);
      if (!npc) return null;

      const feedbackConv = gameState.conversations[npcId] || [];
      const feedbackMessages = feedbackConv.filter((msg, index) => {
        // Find messages after phase changed to feedback
        const prevMessages = feedbackConv.slice(0, index);
        return prevMessages.length > 2; // Assume feedback starts after initial exploration
      });

      if (feedbackMessages.length === 0) {
        return "No feedback was provided to this employee.";
      }

      const prompt = `Summarize the feedback given by the player to ${npc.name} during the feedback phase.
Feedback conversation: ${JSON.stringify(feedbackMessages)}
Provide a concise summary of the key points, tone, and overall assessment the player gave.
Keep it to 3-4 sentences maximum.`;

      return await GameUtils.getLLMResponse(prompt) || "Unable to generate summary";
    }

    async function generateFeedbackReaction(npcId) {
      const npc = gameState.npcs.find(n => n.id === npcId);
      if (!npc) return null;

      // If no feedback summary exists yet, generate it first
      let summary = gameState.feedbackSummaries[npcId];
      if (!summary) {
        summary = await generateFeedbackSummary(npcId);
        gameState.feedbackSummaries[npcId] = summary || 'No feedback provided';
        
        // Update the feedback content display
        const feedbackContent = document.getElementById('reveal-feedback-content');
        if (feedbackContent) {
          feedbackContent.innerHTML = gameState.feedbackSummaries[npcId];
        }
      }

      const prompt = `You are ${npc.name}, with this hidden context: ${npc.secretDescription}.
The player gave you this feedback: "${summary}".
React in character, describing your feelings and thoughts about this feedback (this is fictional).
Consider how your hidden context affects your reaction.
Keep your response to 3-4 sentences that capture your emotional response and private thoughts.`;

      return await GameUtils.getLLMResponse(prompt) || "Unable to generate reaction";
    }

    // Initialize game
    window.addEventListener('DOMContentLoaded', () => {
      initScene();
      updateUI();
      
      // Show initial instructions
      setTimeout(() => {
        showInstructions(
          "Welcome to Feedback Simulation!",
          "Click on employees to talk to them and learn about the workplace situation. Watch the events on the right to see what's happening. When you're ready, press the feedback button to start evaluations."
        );
      }, 1000);
    });

    // Keyboard shortcuts
    document.getElementById('chat-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>

  <div id="instruction-overlay">
    <div class="instruction-content">
      <h2 id="instruction-title">Welcome!</h2>
      <div id="instruction-text">
        <p>Click on employees to talk to them. When you're ready, press the feedback button to start the evaluation phase.</p>
      </div>
      <button class="instruction-btn" onclick="closeInstructions()">Got it!</button>
    </div>
  </div>
</body>
</html>